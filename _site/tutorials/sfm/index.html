<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Kai Wu | Structure from Motion - a tutorial</title>
  <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design.
">

  <link rel="shortcut icon" href="//imkaywu.github.io/assets/img/favicon.ico">
  <link rel="stylesheet" href="//imkaywu.github.io/assets/css/main.css">
  <link rel="canonical" href="//imkaywu.github.io/tutorials/sfm/">
</head>

  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML'></script>

  <body>

    <header class="site-header">

  <div class="wrapper">

    
    <span class="site-title">
        
        <strong>Kai</strong> Wu
    </span>
    

    <nav class="site-nav">

      <div class="trigger">
        <!-- About -->
        <a class="page-link" href="//imkaywu.github.io/">about</a>

        <!-- Blog -->
        <a class="page-link" href="//imkaywu.github.io/blog/">blog</a>

        <!-- Pages -->
        
          
        
          
            <a class="page-link" href="//imkaywu.github.io/code/">code</a>
          
        
          
        
          
            <a class="page-link" href="//imkaywu.github.io/links/">links</a>
          
        
          
        
          
            <a class="page-link" href="//imkaywu.github.io/projects/">projects</a>
          
        
          
            <a class="page-link" href="//imkaywu.github.io/tutorials/">tutorials</a>
          
        
          
        
          
        
          
        
          
        

        <!-- CV link -->
        <!-- <a class="page-link" href="//imkaywu.github.io/assets/pdf/CV.pdf">vitae</a> -->

      </div>
    </nav>

  </div>

</header>



    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Structure from Motion - a tutorial</h1>
    <h5 class="post-description"></h5>
  </header>

  <article class="post-content Structure from Motion - a tutorial clearfix">
    <p>Structure from Motion is the holy grail of multiple view geometry. It is a process of estimating camera pose and retrieving a sparse reconstruction. In this tutorial, I’ll explain every step of this technique and provide detailed implementation using <a href="//imkaywu.github.io/blog/2017/05/3d-vision-lib/">open3DCV</a>. The source code can be found <a href="https://github.com/imkaywu/open3DCV/blob/master/test/sfm.cc">here</a>.</p>

<h3 id="table-of-content">Table of Content</h3>
<ol>
  <li><a href="#test_image">Test images</a></li>
  <li><a href="#image_io">Image IO</a></li>
  <li><a href="#feature_detection">Feature detection</a></li>
  <li><a href="#descriptor_extraction">Descriptor extraction</a></li>
  <li><a href="#feature_matching">Feature matching</a></li>
  <li><a href="#relative_pose">Relative pose estimation</a>
    <ul>
      <li><a href="#class_pair">class <code class="highlighter-rouge">pair</code></a></li>
      <li>Known intrinsic parameters
        <ul>
          <li><a href="#essential">Essential matrix estimation</a></li>
          <li><a href="#fundamental">Fundamental matrix estimation</a></li>
        </ul>
      </li>
      <li>Unknown intrinsic parameters
        <ul>
          <li><a href="#homography">Homography estimation</a></li>
          <li><a href="#f_from_homog">focal length from Homography</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#triangulation">N-view triangulation</a>
    <ul>
      <li><a href="#class_graph">class <code class="highlighter-rouge">Graph</code></a></li>
    </ul>
  </li>
  <li><a href="#bundle_adjustment">Bundle adjustment</a></li>
  <li><a href="#2v_sfm">Two-view SfM</a></li>
  <li><a href="#nv_sfm">N-view SfM</a></li>
  <li><a href="#output">Output</a></li>
</ol>

<h3 id="0-test-images-">0. Test images <a name="test_image"></a></h3>
<p>I used the <code class="highlighter-rouge">bust</code> images from Jianxiong Xiao’s SfM tutorial, and <code class="highlighter-rouge">templeSparseRing</code> dataset from Middlebury mview datasets. The directory of the test images is</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="n">string</span> <span class="n">idir</span> <span class="o">=</span> <span class="s">"/Users/BlacKay/Documents/Projects/Images/test/bust/"</span><span class="p">;</span>
<span class="c1">// string idir = "/Users/BlacKay/Documents/Projects/Images/test/templeSparseRing/";
</span></code></pre>
</div>

<h3 id="1-image-io-">1. Image IO <a name="image_io"></a></h3>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="k">const</span> <span class="kt">int</span> <span class="n">nimages</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">inames</span><span class="p">(</span><span class="n">nimages</span><span class="p">);</span>
<span class="n">inames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">idir</span> <span class="o">+</span> <span class="s">"B21.jpg"</span><span class="p">;</span>
<span class="n">inames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">idir</span> <span class="o">+</span> <span class="s">"B22.jpg"</span><span class="p">;</span>
<span class="n">inames</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">idir</span> <span class="o">+</span> <span class="s">"B23.jpg"</span><span class="p">;</span>
<span class="n">inames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">idir</span> <span class="o">+</span> <span class="s">"B24.jpg"</span><span class="p">;</span>
<span class="n">inames</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">idir</span> <span class="o">+</span> <span class="s">"B25.jpg"</span><span class="p">;</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">Image</span><span class="o">&gt;</span> <span class="n">images</span><span class="p">(</span><span class="n">nimages</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nimages</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">read</span><span class="p">(</span><span class="n">inames</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="2-feature-detection-">2. Feature detection <a name="feature_detection"></a></h3>
<div class="img_row">
    <img class="col one" src="/assets/img/open3DCV/sfm/feature1.jpg" alt="" title="example image" />
    <img class="col one" src="/assets/img/open3DCV/sfm/feature2.jpg" alt="" title="example image" />
    <img class="col one" src="/assets/img/open3DCV/sfm/feature3.jpg" alt="" title="example image" />
</div>
<div class="img_row">
    <img class="col one" src="/assets/img/open3DCV/sfm/feature4.jpg" alt="" title="example image" />
    <img class="col one" src="/assets/img/open3DCV/sfm/feature5.jpg" alt="" title="example image" />
</div>
<div class="col three caption">
    Results of feature detection.
</div>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="n">Sift_Params</span> <span class="n">sift_param</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">10.0</span><span class="n">f</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">INFINITY</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="n">Sift</span> <span class="n">sift</span><span class="p">(</span><span class="n">sift_param</span><span class="p">);</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Keypoint</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">keys</span><span class="p">(</span><span class="n">nimages</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Keypoint</span><span class="o">&gt;</span><span class="p">());</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Vecf</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">descs</span><span class="p">(</span><span class="n">nimages</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Vecf</span><span class="o">&gt;</span><span class="p">());</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nimages</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">sift</span><span class="p">.</span><span class="n">detect_keypoints</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">sift</span><span class="p">.</span><span class="n">extract_descriptors</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">descs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">sift</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span> <span class="c1">// don't forget this
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">is_vis</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">draw_cross</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">"feature_"</span><span class="o">+</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="3-descriptor-extraction-">3. Descriptor extraction <a href="descriptor_extraction"></a></h3>
<p>The code above also extract descriptors from detected features.</p>

<h3 id="4-feature-matching-">4. Feature matching <a name="feature_matching"></a></h3>
<p>See the matching results below</p>
<div class="img_row">
    <img class="col one" src="/assets/img/open3DCV/sfm/matching_inlier1_2.jpg" alt="" title="example image" />
    <img class="col one" src="/assets/img/open3DCV/sfm/matching_inlier2_3.jpg" alt="" title="example image" />
    <img class="col one" src="/assets/img/open3DCV/sfm/matching_inlier3_4.jpg" alt="" title="example image" />
</div>
<div class="img_row">
    <img class="col one" src="/assets/img/open3DCV/sfm/matching_inlier4_5.jpg" alt="" title="example image" />
</div>
<div class="col three caption">
    Results of feature matching.
</div>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="n">Matcher_Param</span> <span class="n">matcher_param</span><span class="p">;</span>
<span class="n">Matcher_Flann</span> <span class="n">matcher</span><span class="p">(</span><span class="n">matcher_param</span><span class="p">);</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Match</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">matches</span><span class="p">(</span><span class="n">nimages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Match</span><span class="o">&gt;</span><span class="p">());</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nimages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nimages</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">matcher</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="n">descs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">descs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">matches</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_vis</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">draw_matches</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">images</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">matches</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">"matching"</span><span class="o">+</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre>
</div>

<h3 id="5-relative-pose-estimation-">5. Relative pose estimation <a name="relative_pose"></a></h3>

<h4 id="class-pair-">class <code class="highlighter-rouge">pair</code> <a name="class_pair"></a></h4>
<p>We first need to define a class <code class="highlighter-rouge">pair</code> to store information of an image pair, which is defined as follows:</p>
<ul>
  <li>camera indexes: <code class="highlighter-rouge">ind_cam_</code>;</li>
  <li>matching features: <code class="highlighter-rouge">matches_</code>;</li>
  <li>fundamental and essential matrix: <code class="highlighter-rouge">F_</code>, <code class="highlighter-rouge">E_</code>;</li>
  <li>intrinsics and extrinsics of the corresponding cameras: <code class="highlighter-rouge">intrinsics_mat_</code>, <code class="highlighter-rouge">extrinsics_mat_</code>.</li>
</ul>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Pair</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">Pair</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ind_cam1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ind_cam2</span><span class="p">);</span>
    <span class="n">Pair</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ind_cam1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ind_cam2</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="p">,</span> <span class="n">Vec2f</span><span class="o">&gt;</span> <span class="o">&gt;&amp;</span> <span class="n">matches</span><span class="p">);</span>
    <span class="o">~</span><span class="n">Pair</span><span class="p">();</span>
    
    <span class="kt">void</span> <span class="n">update_matches</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="p">,</span> <span class="n">Vec2f</span><span class="o">&gt;</span> <span class="o">&gt;&amp;</span> <span class="n">matches</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span><span class="o">*</span> <span class="n">vote_inlier</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">update_intrinsics</span><span class="p">(</span><span class="k">const</span> <span class="kt">float</span> <span class="n">f</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">h</span><span class="p">);</span>
    
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">ind_cam_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="p">,</span> <span class="n">Vec2f</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">matches_</span><span class="p">;</span>
    <span class="n">Mat3f</span> <span class="n">F_</span><span class="p">;</span>
    <span class="n">Mat3f</span> <span class="n">E_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Mat3f</span><span class="o">&gt;</span> <span class="n">intrinsics_mat_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Mat34f</span><span class="o">&gt;</span> <span class="n">extrinsics_mat_</span><span class="p">;</span>
    
<span class="k">private</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">init</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ind_cam1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ind_cam2</span><span class="p">);</span>
<span class="p">};</span>
</code></pre>
</div>

<h4 id="known-intrinsic-parameters">Known intrinsic parameters</h4>
<p>Assuming the cameras have been calibrated, thus euclidean (metric) reconstruction is possible.</p>

<h5 id="estimate-essential-matrix-">Estimate essential matrix <a name="essential"></a></h5>
<p>[TBD]</p>

<h5 id="estimate-fundamental-matrix-">Estimate fundamental matrix <a name="fundamental"></a></h5>
<p>I use the <code class="highlighter-rouge">7-point algorithm</code> + <code class="highlighter-rouge">RANSAC</code> to estimate fundamental matrix. See the results below.</p>
<div class="img_row">
    <img class="col one" src="/assets/img/open3DCV/sfm/epipolar1_2.jpg" alt="" title="example image" />
    <img class="col one" src="/assets/img/open3DCV/sfm/epipolar2_3.jpg" alt="" title="example image" />
    <img class="col one" src="/assets/img/open3DCV/sfm/epipolar3_4.jpg" alt="" title="example image" />
</div>
<div class="img_row">
    <img class="col one" src="/assets/img/open3DCV/sfm/epipolar4_5.jpg" alt="" title="example image" />
</div>
<div class="col three caption">
    Results of fundamental matrix.
</div>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="c1">// variable to store the coordinates of matching features
</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="p">,</span> <span class="n">Vec2f</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nimages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"*******************************"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">" 2-View SfM of image "</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">" and "</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"*******************************"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="c1">// ------ image pair ------
</span>    <span class="n">Pair</span> <span class="n">pair</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">nmatches</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">());</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nmatches</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Vec2f</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">matches</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">ikey1_</span><span class="p">].</span><span class="n">coords</span><span class="p">();</span>
        <span class="n">Vec2f</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">matches</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">ikey2_</span><span class="p">].</span><span class="n">coords</span><span class="p">();</span>
        <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="p">,</span> <span class="n">Vec2f</span><span class="o">&gt;</span> <span class="n">pair_data</span><span class="p">;</span>
        <span class="n">pair_data</span><span class="p">.</span><span class="n">first</span> <span class="o">=</span> <span class="n">x1</span><span class="p">;</span>
        <span class="n">pair_data</span><span class="p">.</span><span class="n">second</span> <span class="o">=</span> <span class="n">x2</span><span class="p">;</span>
        <span class="n">data</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pair_data</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">vote_inlier</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="n">nmatches</span><span class="p">];</span>
    <span class="n">std</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="n">vote_inlier</span><span class="p">,</span> <span class="n">vote_inlier</span> <span class="o">+</span> <span class="n">nmatches</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">pair</span><span class="p">.</span><span class="n">update_matches</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vote_inlier</span><span class="p">);</span>
    
    <span class="c1">// ------ estimate Fundamental matrix ------
</span>    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">params</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
    <span class="n">Param_Estimator</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="p">,</span> <span class="n">Vec2f</span><span class="o">&gt;</span><span class="p">,</span> <span class="kt">float</span><span class="o">&gt;*</span> <span class="n">fund_esti</span> <span class="o">=</span> <span class="k">new</span> <span class="n">open3DCV</span><span class="o">::</span><span class="n">Fundamental_Estimator</span><span class="p">(</span><span class="mf">10e-8</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">ratio_inlier</span> <span class="o">=</span> <span class="n">Ransac</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="p">,</span> <span class="n">Vec2f</span><span class="o">&gt;</span><span class="p">,</span> <span class="kt">float</span><span class="o">&gt;::</span><span class="n">estimate</span><span class="p">(</span><span class="n">fund_esti</span><span class="p">,</span> <span class="n">pair</span><span class="p">.</span><span class="n">matches_</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">vote_inlier</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"ratio of matching inliers: "</span> <span class="o">&lt;&lt;</span> <span class="n">ratio_inlier</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">pair</span><span class="p">.</span><span class="n">F_</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
               <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
               <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    
    <span class="c1">// remove outliers
</span>    <span class="n">pair</span><span class="p">.</span><span class="n">update_matches</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vote_inlier</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"number of matches: "</span> <span class="o">&lt;&lt;</span> <span class="n">pair</span><span class="p">.</span><span class="n">matches_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="c1">// ------ other code ------
</span>
    <span class="k">delete</span> <span class="p">[]</span> <span class="n">vote_inlier</span><span class="p">;</span>
    <span class="n">data</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>
</div>

<h5 id="estimate-pose-and-orientation-of-camera-pair-">Estimate pose and orientation of camera pair <a name="rt_from_e"></a></h5>
<p>We can estimate the relative position and orientation of two cameras from Essential matrix, the detail is discussed in <a href="//imkaywu.github.io//blog/2017/09/relative-pose/">this post</a>.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="c1">// ------ estimate relative pose ------
// ugly, but works for now
</span><span class="k">const</span> <span class="kt">float</span> <span class="n">f</span> <span class="o">=</span> <span class="mf">719.5459</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">640</span><span class="p">;</span>
<span class="n">pair</span><span class="p">.</span><span class="n">update_intrinsics</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
<span class="n">pair</span><span class="p">.</span><span class="n">E_</span> <span class="o">=</span> <span class="n">pair</span><span class="p">.</span><span class="n">intrinsics_mat_</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">pair</span><span class="p">.</span><span class="n">F_</span> <span class="o">*</span> <span class="n">pair</span><span class="p">.</span><span class="n">intrinsics_mat_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">Rt_from_E</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span>
</code></pre>
</div>

<h4 id="unknown-intrinsic-parameters">Unknown intrinsic parameters</h4>
<p>Assuming that the cameras have not been calibrated, in this case, the scene is reconstructed up to a projective projection.</p>

<h5 id="estimate-homography-">Estimate homography <a name="homography"></a></h5>
<p>[TBD]</p>

<h5 id="estimate-focal-length-from-homography-">Estimate focal length from homography <a name="f_from_homog"></a></h5>
<p>[TBD]</p>

<h3 id="6-n-view-triangulation-">6. N-view triangulation <a name="triangulation"></a></h3>
<p>The N-view triangulation is discussed in <a href="//imkaywu.github.io//blog/2017/07/triangulation/">this pose</a>. I use the <code class="highlighter-rouge">triangulate_nonlinear()</code> method to compute the 3D points.</p>

<h4 id="class-graph-">class <code class="highlighter-rouge">Graph</code> <a name="class_graph"></a></h4>
<p>The class <code class="highlighter-rouge">Graph</code> is heavily used hereafter, it is a data type that stores multiple camera views with sufficient amount of matching features, the corresponding camera poses/orientations, and sparse 3D points, the detailed definition is as follows</p>

<ul>
  <li>number of cameras: <code class="highlighter-rouge">ncams_</code>;</li>
  <li>indexes of cameras: <code class="highlighter-rouge">ind_cam_</code>;</li>
  <li>Fundamental and Essential matrix: <code class="highlighter-rouge">F_</code>, <code class="highlighter-rouge">E_</code>;</li>
  <li>intrinsics and extrinsics of cameras: <code class="highlighter-rouge">intrinsics_mat_</code>, <code class="highlighter-rouge">extrinsics_mat_</code>;</li>
  <li>point tracks: <code class="highlighter-rouge">tracks_</code>. Each set of matching pixels across multiple images should correspond to a single point in 3D, i.e., each individual pixel in a matched set should be the projection of the same 3D point.</li>
  <li>structure points: <code class="highlighter-rouge">structure_points_</code>, a fancier version of 3D point.</li>
</ul>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Graph</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">Graph</span><span class="p">();</span>
    <span class="n">Graph</span><span class="p">(</span><span class="k">const</span> <span class="n">Pair</span><span class="o">&amp;</span> <span class="n">pair</span><span class="p">);</span>
    <span class="o">~</span><span class="n">Graph</span><span class="p">();</span>
    
    <span class="kt">void</span> <span class="n">init</span><span class="p">(</span><span class="k">const</span> <span class="n">Pair</span><span class="o">&amp;</span> <span class="n">pair</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">index</span><span class="p">(</span><span class="kt">int</span> <span class="n">icam</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">size</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">intersect</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Track</span><span class="o">&gt;&amp;</span> <span class="n">tracks1</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Track</span><span class="o">&gt;&amp;</span> <span class="n">tracks2</span><span class="p">);</span>
    
    <span class="kt">int</span> <span class="n">ncams_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">ind_cam_</span><span class="p">;</span>
    <span class="n">Mat3f</span> <span class="n">F_</span><span class="p">;</span>
    <span class="n">Mat3f</span> <span class="n">E_</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">f_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Mat3f</span><span class="o">&gt;</span> <span class="n">intrinsics_mat_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Mat34f</span><span class="o">&gt;</span> <span class="n">extrinsics_mat_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Track</span><span class="o">&gt;</span> <span class="n">tracks_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Structure_Point</span><span class="o">&gt;</span> <span class="n">structure_points_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">triangulate_nonlinear</code> takes a <code class="highlighter-rouge">Graph</code> instance as input and compute the <code class="highlighter-rouge">structure_points_</code> from feature tracks and relative poses.</p>
<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="n">triangulate_nonlinear</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="c1">// compute reprojection error
</span><span class="kt">float</span> <span class="n">error</span> <span class="o">=</span> <span class="n">reprojection_error</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"reprojection error (before bundle adjustment): "</span> <span class="o">&lt;&lt;</span> <span class="n">error</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="7-bundle-adjustment-">7. Bundle adjustment <a name="bundle_adjustment"></a></h3>
<p>The detailed bundle adjustment for SfM is discussed in <a href="//imkaywu.github.io//blog/2017/09/sfm-bundle-adjustment/">this post</a>.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="c1">// ------ bundle adjustment ------
</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"------ start bundle adjustment ------"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="n">Open3DCVBundleAdjustment</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">BUNDLE_PRINCIPAL_POINT</span><span class="p">);</span>
<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"------ end bundle adjustment ------"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">reprojection_error</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"reprojection error (after bundle adjustment): "</span> <span class="o">&lt;&lt;</span> <span class="n">error</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="8-two-view-sfm-">8. Two-view SfM <a name="2v_sfm"></a></h3>
<p>For each <code class="highlighter-rouge">Graph</code> instance, we repeat the step 1-7 to compute both camera parameters, poses, orientations, and a sparse set of 3D points. This process is called two-view Structure from Motion. See the running results below:</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="o">*******************************</span>
 <span class="mi">2</span><span class="o">-</span><span class="n">View</span> <span class="n">SfM</span> <span class="n">of</span> <span class="n">image</span> <span class="mi">0</span> <span class="n">and</span> <span class="mi">1</span>
<span class="o">*******************************</span>
<span class="n">ratio</span> <span class="n">of</span> <span class="n">matching</span> <span class="n">inliers</span><span class="o">:</span> <span class="mf">0.988506</span>
<span class="n">number</span> <span class="n">of</span> <span class="n">matches</span><span class="o">:</span> <span class="mi">172</span>
<span class="n">reprojection</span> <span class="n">error</span> <span class="p">(</span><span class="n">before</span> <span class="n">bundle</span> <span class="n">adjustment</span><span class="p">)</span><span class="o">:</span> <span class="mf">3.87837</span>
<span class="o">------</span> <span class="n">start</span> <span class="n">bundle</span> <span class="n">adjustment</span> <span class="o">------</span>
<span class="n">iter</span>      <span class="n">cost</span>      <span class="n">cost_change</span>  <span class="o">|</span><span class="n">gradient</span><span class="o">|</span>   <span class="o">|</span><span class="n">step</span><span class="o">|</span>    <span class="n">tr_ratio</span>  <span class="n">tr_radius</span>  <span class="n">ls_iter</span>  <span class="n">iter_time</span>  <span class="n">total_time</span>
   <span class="mi">0</span>  <span class="mf">2.885275e+03</span>    <span class="mf">0.00e+00</span>    <span class="mf">4.96e+05</span>   <span class="mf">0.00e+00</span>   <span class="mf">0.00e+00</span>  <span class="mf">1.00e+04</span>        <span class="mi">0</span>    <span class="mf">3.84e-02</span>    <span class="mf">4.09e-02</span>
   <span class="mi">1</span>  <span class="mf">1.967958e+02</span>    <span class="mf">2.69e+03</span>    <span class="mf">2.71e+02</span>   <span class="mf">6.75e+01</span>   <span class="mf">1.00e+00</span>  <span class="mf">3.00e+04</span>        <span class="mi">2</span>    <span class="mf">2.11e-01</span>    <span class="mf">2.52e-01</span>
   <span class="mi">2</span>  <span class="mf">1.930865e+02</span>    <span class="mf">3.71e+00</span>    <span class="mf">1.84e+02</span>   <span class="mf">7.41e+01</span>   <span class="mf">1.00e+00</span>  <span class="mf">9.00e+04</span>        <span class="mi">4</span>    <span class="mf">2.11e-01</span>    <span class="mf">4.64e-01</span>
   <span class="mi">3</span>  <span class="mf">1.922473e+02</span>    <span class="mf">8.39e-01</span>    <span class="mf">1.40e+03</span>   <span class="mf">1.44e+01</span>   <span class="mf">1.00e+00</span>  <span class="mf">2.70e+05</span>        <span class="mi">4</span>    <span class="mf">3.42e-02</span>    <span class="mf">4.98e-01</span>
   <span class="mi">4</span>  <span class="mf">2.242285e+02</span>   <span class="o">-</span><span class="mf">3.20e+01</span>    <span class="mf">1.95e+04</span>   <span class="mf">5.30e+01</span>   <span class="mf">9.87e-01</span>  <span class="mf">8.10e+05</span>        <span class="mi">9</span>    <span class="mf">3.54e-02</span>    <span class="mf">5.33e-01</span>
   <span class="mi">5</span>  <span class="mf">1.879325e+02</span>    <span class="mf">3.63e+01</span>    <span class="mf">1.50e+02</span>   <span class="mf">3.25e+01</span>   <span class="mf">1.00e+00</span>  <span class="mf">2.43e+06</span>        <span class="mi">3</span>    <span class="mf">3.41e-02</span>    <span class="mf">5.67e-01</span>
   <span class="mi">6</span>  <span class="mf">1.947733e+02</span>   <span class="o">-</span><span class="mf">6.84e+00</span>    <span class="mf">9.32e+03</span>   <span class="mf">4.59e+01</span>   <span class="mf">9.84e-01</span>  <span class="mf">7.29e+06</span>        <span class="mi">9</span>    <span class="mf">3.85e-02</span>    <span class="mf">6.06e-01</span>
   <span class="mi">7</span>  <span class="mf">1.873827e+02</span>    <span class="mf">7.39e+00</span>    <span class="mf">3.45e+01</span>   <span class="mf">1.17e+01</span>   <span class="mf">1.00e+00</span>  <span class="mf">2.19e+07</span>        <span class="mi">3</span>    <span class="mf">3.73e-02</span>    <span class="mf">6.43e-01</span>
   <span class="mi">8</span>  <span class="mf">1.873775e+02</span>    <span class="mf">5.22e-03</span>    <span class="mf">1.56e+02</span>   <span class="mf">5.25e+00</span>   <span class="mf">9.84e-01</span>  <span class="mf">6.56e+07</span>        <span class="mi">9</span>    <span class="mf">4.01e-02</span>    <span class="mf">6.84e-01</span>
   <span class="mi">9</span>  <span class="mf">1.873755e+02</span>    <span class="mf">1.94e-03</span>    <span class="mf">3.41e-01</span>   <span class="mf">2.34e-01</span>   <span class="mf">1.00e+00</span>  <span class="mf">1.97e+08</span>        <span class="mi">9</span>    <span class="mf">4.21e-02</span>    <span class="mf">7.26e-01</span>
<span class="n">Ceres</span> <span class="n">Solver</span> <span class="n">Report</span><span class="o">:</span> <span class="n">Iterations</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span> <span class="n">Initial</span> <span class="n">cost</span><span class="o">:</span> <span class="mf">2.885275e+03</span><span class="p">,</span> <span class="n">Final</span> <span class="n">cost</span><span class="o">:</span> <span class="mf">1.873755e+02</span><span class="p">,</span> <span class="n">Termination</span><span class="o">:</span> <span class="n">CONVERGENCE</span>
<span class="o">------</span> <span class="n">end</span> <span class="n">bundle</span> <span class="n">adjustment</span> <span class="o">------</span>
<span class="n">reprojection</span> <span class="n">error</span> <span class="p">(</span><span class="n">after</span> <span class="n">bundle</span> <span class="n">adjustment</span><span class="p">)</span><span class="o">:</span> <span class="mf">0.43175</span>
<span class="o">*******************************</span>
 <span class="mi">2</span><span class="o">-</span><span class="n">View</span> <span class="n">SfM</span> <span class="n">of</span> <span class="n">image</span> <span class="mi">1</span> <span class="n">and</span> <span class="mi">2</span>
<span class="o">*******************************</span>
<span class="n">ratio</span> <span class="n">of</span> <span class="n">matching</span> <span class="n">inliers</span><span class="o">:</span> <span class="mf">0.916667</span>
<span class="n">number</span> <span class="n">of</span> <span class="n">matches</span><span class="o">:</span> <span class="mi">110</span>
<span class="n">reprojection</span> <span class="n">error</span> <span class="p">(</span><span class="n">before</span> <span class="n">bundle</span> <span class="n">adjustment</span><span class="p">)</span><span class="o">:</span> <span class="mf">2.25564</span>
<span class="o">------</span> <span class="n">start</span> <span class="n">bundle</span> <span class="n">adjustment</span> <span class="o">------</span>
<span class="n">iter</span>      <span class="n">cost</span>      <span class="n">cost_change</span>  <span class="o">|</span><span class="n">gradient</span><span class="o">|</span>   <span class="o">|</span><span class="n">step</span><span class="o">|</span>    <span class="n">tr_ratio</span>  <span class="n">tr_radius</span>  <span class="n">ls_iter</span>  <span class="n">iter_time</span>  <span class="n">total_time</span>
   <span class="mi">0</span>  <span class="mf">7.923923e+02</span>    <span class="mf">0.00e+00</span>    <span class="mf">1.81e+05</span>   <span class="mf">0.00e+00</span>   <span class="mf">0.00e+00</span>  <span class="mf">1.00e+04</span>        <span class="mi">0</span>    <span class="mf">1.92e-02</span>    <span class="mf">2.02e-02</span>
   <span class="mi">1</span>  <span class="mf">8.861546e+01</span>    <span class="mf">7.04e+02</span>    <span class="mf">2.30e+02</span>   <span class="mf">1.79e+01</span>   <span class="mf">9.87e-01</span>  <span class="mf">3.00e+04</span>        <span class="mi">2</span>    <span class="mf">1.44e-01</span>    <span class="mf">1.64e-01</span>
   <span class="mi">2</span>  <span class="mf">8.837636e+01</span>    <span class="mf">2.39e-01</span>    <span class="mf">2.77e+02</span>   <span class="mf">1.17e+00</span>   <span class="mf">9.87e-01</span>  <span class="mf">9.00e+04</span>        <span class="mi">3</span>    <span class="mf">1.21e-01</span>    <span class="mf">2.85e-01</span>
   <span class="mi">3</span>  <span class="mf">8.811263e+01</span>    <span class="mf">2.64e-01</span>    <span class="mf">5.18e+03</span>   <span class="mf">1.05e+01</span>   <span class="mf">9.85e-01</span>  <span class="mf">2.70e+05</span>        <span class="mi">8</span>    <span class="mf">1.92e-02</span>    <span class="mf">3.04e-01</span>
   <span class="mi">4</span>  <span class="mf">9.234304e+01</span>   <span class="o">-</span><span class="mf">4.23e+00</span>    <span class="mf">1.23e+04</span>   <span class="mf">1.62e+01</span>   <span class="mf">9.77e-01</span>  <span class="mf">8.10e+05</span>        <span class="mi">7</span>    <span class="mf">2.07e-02</span>    <span class="mf">3.25e-01</span>
   <span class="mi">5</span>  <span class="mf">9.005855e+01</span>    <span class="mf">2.28e+00</span>    <span class="mf">7.36e+03</span>   <span class="mf">1.24e+01</span>   <span class="mf">9.73e-01</span>  <span class="mf">2.43e+06</span>        <span class="mi">7</span>    <span class="mf">1.99e-02</span>    <span class="mf">3.45e-01</span>
   <span class="mi">6</span>  <span class="mf">8.677939e+01</span>    <span class="mf">3.28e+00</span>    <span class="mf">1.15e+03</span>   <span class="mf">4.87e+00</span>   <span class="mf">9.73e-01</span>  <span class="mf">7.29e+06</span>        <span class="mi">7</span>    <span class="mf">1.96e-02</span>    <span class="mf">3.65e-01</span>
   <span class="mi">7</span>  <span class="mf">8.661048e+01</span>    <span class="mf">1.69e-01</span>    <span class="mf">4.21e+01</span>   <span class="mf">1.31e+00</span>   <span class="mf">9.99e-01</span>  <span class="mf">2.19e+07</span>        <span class="mi">7</span>    <span class="mf">2.20e-02</span>    <span class="mf">3.87e-01</span>
   <span class="mi">8</span>  <span class="mf">8.661011e+01</span>    <span class="mf">3.66e-04</span>    <span class="mf">6.15e+01</span>   <span class="mf">1.26e+00</span>   <span class="mf">9.73e-01</span>  <span class="mf">6.56e+07</span>        <span class="mi">7</span>    <span class="mf">2.20e-02</span>    <span class="mf">4.09e-01</span>
   <span class="mi">9</span>  <span class="mf">8.660974e+01</span>    <span class="mf">3.73e-04</span>    <span class="mf">6.49e+00</span>   <span class="mf">4.53e-01</span>   <span class="mf">9.73e-01</span>  <span class="mf">1.97e+08</span>        <span class="mi">7</span>    <span class="mf">2.26e-02</span>    <span class="mf">4.31e-01</span>
<span class="n">Ceres</span> <span class="n">Solver</span> <span class="n">Report</span><span class="o">:</span> <span class="n">Iterations</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span> <span class="n">Initial</span> <span class="n">cost</span><span class="o">:</span> <span class="mf">7.923923e+02</span><span class="p">,</span> <span class="n">Final</span> <span class="n">cost</span><span class="o">:</span> <span class="mf">8.660974e+01</span><span class="p">,</span> <span class="n">Termination</span><span class="o">:</span> <span class="n">CONVERGENCE</span>
<span class="o">------</span> <span class="n">end</span> <span class="n">bundle</span> <span class="n">adjustment</span> <span class="o">------</span>
<span class="n">reprojection</span> <span class="n">error</span> <span class="p">(</span><span class="n">after</span> <span class="n">bundle</span> <span class="n">adjustment</span><span class="p">)</span><span class="o">:</span> <span class="mf">0.381238</span>
<span class="o">*******************************</span>
 <span class="mi">2</span><span class="o">-</span><span class="n">View</span> <span class="n">SfM</span> <span class="n">of</span> <span class="n">image</span> <span class="mi">2</span> <span class="n">and</span> <span class="mi">3</span>
<span class="o">*******************************</span>
<span class="n">ratio</span> <span class="n">of</span> <span class="n">matching</span> <span class="n">inliers</span><span class="o">:</span> <span class="mf">0.967742</span>
<span class="n">number</span> <span class="n">of</span> <span class="n">matches</span><span class="o">:</span> <span class="mi">120</span>
<span class="n">reprojection</span> <span class="n">error</span> <span class="p">(</span><span class="n">before</span> <span class="n">bundle</span> <span class="n">adjustment</span><span class="p">)</span><span class="o">:</span> <span class="mf">2.01501</span>
<span class="o">------</span> <span class="n">start</span> <span class="n">bundle</span> <span class="n">adjustment</span> <span class="o">------</span>
<span class="n">iter</span>      <span class="n">cost</span>      <span class="n">cost_change</span>  <span class="o">|</span><span class="n">gradient</span><span class="o">|</span>   <span class="o">|</span><span class="n">step</span><span class="o">|</span>    <span class="n">tr_ratio</span>  <span class="n">tr_radius</span>  <span class="n">ls_iter</span>  <span class="n">iter_time</span>  <span class="n">total_time</span>
   <span class="mi">0</span>  <span class="mf">5.076611e+02</span>    <span class="mf">0.00e+00</span>    <span class="mf">1.77e+05</span>   <span class="mf">0.00e+00</span>   <span class="mf">0.00e+00</span>  <span class="mf">1.00e+04</span>        <span class="mi">0</span>    <span class="mf">2.20e-02</span>    <span class="mf">2.31e-02</span>
   <span class="mi">1</span>  <span class="mf">1.520502e+01</span>    <span class="mf">4.92e+02</span>    <span class="mf">1.94e+02</span>   <span class="mf">2.60e+00</span>   <span class="mf">1.00e+00</span>  <span class="mf">3.00e+04</span>        <span class="mi">2</span>    <span class="mf">1.39e-01</span>    <span class="mf">1.62e-01</span>
   <span class="mi">2</span>  <span class="mf">1.435592e+01</span>    <span class="mf">8.49e-01</span>    <span class="mf">1.50e+02</span>   <span class="mf">4.68e+00</span>   <span class="mf">1.00e+00</span>  <span class="mf">9.00e+04</span>       <span class="mi">10</span>    <span class="mf">2.49e-02</span>    <span class="mf">1.87e-01</span>
   <span class="mi">3</span>  <span class="mf">1.431633e+01</span>    <span class="mf">3.96e-02</span>    <span class="mf">4.29e+01</span>   <span class="mf">2.89e+00</span>   <span class="mf">1.00e+00</span>  <span class="mf">2.70e+05</span>        <span class="mi">9</span>    <span class="mf">2.89e-02</span>    <span class="mf">2.16e-01</span>
   <span class="mi">4</span>  <span class="mf">1.430186e+01</span>    <span class="mf">1.45e-02</span>    <span class="mf">5.72e+01</span>   <span class="mf">3.77e+00</span>   <span class="mf">1.00e+00</span>  <span class="mf">8.10e+05</span>        <span class="mi">7</span>    <span class="mf">3.23e-02</span>    <span class="mf">2.48e-01</span>
   <span class="mi">5</span>  <span class="mf">1.429232e+01</span>    <span class="mf">9.54e-03</span>    <span class="mf">4.04e+01</span>   <span class="mf">2.46e+00</span>   <span class="mf">1.00e+00</span>  <span class="mf">2.43e+06</span>        <span class="mi">7</span>    <span class="mf">2.29e-02</span>    <span class="mf">2.71e-01</span>
   <span class="mi">6</span>  <span class="mf">1.428941e+01</span>    <span class="mf">2.91e-03</span>    <span class="mf">4.77e+00</span>   <span class="mf">1.09e+00</span>   <span class="mf">1.00e+00</span>  <span class="mf">7.29e+06</span>        <span class="mi">9</span>    <span class="mf">2.17e-02</span>    <span class="mf">2.93e-01</span>
   <span class="mi">7</span>  <span class="mf">1.428935e+01</span>    <span class="mf">5.70e-05</span>    <span class="mf">4.03e-01</span>   <span class="mf">4.41e-02</span>   <span class="mf">1.00e+00</span>  <span class="mf">2.19e+07</span>        <span class="mi">2</span>    <span class="mf">2.10e-02</span>    <span class="mf">3.14e-01</span>
<span class="n">Ceres</span> <span class="n">Solver</span> <span class="n">Report</span><span class="o">:</span> <span class="n">Iterations</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span> <span class="n">Initial</span> <span class="n">cost</span><span class="o">:</span> <span class="mf">5.076611e+02</span><span class="p">,</span> <span class="n">Final</span> <span class="n">cost</span><span class="o">:</span> <span class="mf">1.428935e+01</span><span class="p">,</span> <span class="n">Termination</span><span class="o">:</span> <span class="n">CONVERGENCE</span>
<span class="o">------</span> <span class="n">end</span> <span class="n">bundle</span> <span class="n">adjustment</span> <span class="o">------</span>
<span class="n">reprojection</span> <span class="n">error</span> <span class="p">(</span><span class="n">after</span> <span class="n">bundle</span> <span class="n">adjustment</span><span class="p">)</span><span class="o">:</span> <span class="mf">0.238207</span>
<span class="o">*******************************</span>
 <span class="mi">2</span><span class="o">-</span><span class="n">View</span> <span class="n">SfM</span> <span class="n">of</span> <span class="n">image</span> <span class="mi">3</span> <span class="n">and</span> <span class="mi">4</span>
<span class="o">*******************************</span>
<span class="n">ratio</span> <span class="n">of</span> <span class="n">matching</span> <span class="n">inliers</span><span class="o">:</span> <span class="mf">0.840426</span>
<span class="n">number</span> <span class="n">of</span> <span class="n">matches</span><span class="o">:</span> <span class="mi">79</span>
<span class="n">reprojection</span> <span class="n">error</span> <span class="p">(</span><span class="n">before</span> <span class="n">bundle</span> <span class="n">adjustment</span><span class="p">)</span><span class="o">:</span> <span class="mf">1.19674</span>
<span class="o">------</span> <span class="n">start</span> <span class="n">bundle</span> <span class="n">adjustment</span> <span class="o">------</span>
<span class="n">iter</span>      <span class="n">cost</span>      <span class="n">cost_change</span>  <span class="o">|</span><span class="n">gradient</span><span class="o">|</span>   <span class="o">|</span><span class="n">step</span><span class="o">|</span>    <span class="n">tr_ratio</span>  <span class="n">tr_radius</span>  <span class="n">ls_iter</span>  <span class="n">iter_time</span>  <span class="n">total_time</span>
   <span class="mi">0</span>  <span class="mf">1.606857e+02</span>    <span class="mf">0.00e+00</span>    <span class="mf">7.20e+04</span>   <span class="mf">0.00e+00</span>   <span class="mf">0.00e+00</span>  <span class="mf">1.00e+04</span>        <span class="mi">0</span>    <span class="mf">1.39e-02</span>    <span class="mf">1.48e-02</span>
   <span class="mi">1</span>  <span class="mf">6.570561e+00</span>    <span class="mf">1.54e+02</span>    <span class="mf">1.25e+01</span>   <span class="mf">6.56e+00</span>   <span class="mf">1.00e+00</span>  <span class="mf">3.00e+04</span>        <span class="mi">3</span>    <span class="mf">8.53e-02</span>    <span class="mf">1.00e-01</span>
   <span class="mi">2</span>  <span class="mf">6.563225e+00</span>    <span class="mf">7.34e-03</span>    <span class="mf">4.53e-01</span>   <span class="mf">8.34e-01</span>   <span class="mf">1.00e+00</span>  <span class="mf">9.00e+04</span>        <span class="mi">7</span>    <span class="mf">7.00e-02</span>    <span class="mf">1.70e-01</span>
   <span class="mi">3</span>  <span class="mf">6.553658e+00</span>    <span class="mf">9.57e-03</span>    <span class="mf">1.51e+01</span>   <span class="mf">2.09e+00</span>   <span class="mf">1.00e+00</span>  <span class="mf">2.70e+05</span>        <span class="mi">5</span>    <span class="mf">1.48e-02</span>    <span class="mf">1.85e-01</span>
   <span class="mi">4</span>  <span class="mf">6.541664e+00</span>    <span class="mf">1.20e-02</span>    <span class="mf">6.03e+01</span>   <span class="mf">5.22e+00</span>   <span class="mf">1.00e+00</span>  <span class="mf">8.10e+05</span>        <span class="mi">8</span>    <span class="mf">1.43e-02</span>    <span class="mf">1.99e-01</span>
   <span class="mi">5</span>  <span class="mf">6.561159e+00</span>   <span class="o">-</span><span class="mf">1.95e-02</span>    <span class="mf">5.65e+01</span>   <span class="mf">7.57e+00</span>   <span class="mf">9.99e-01</span>  <span class="mf">2.43e+06</span>        <span class="mi">8</span>    <span class="mf">1.39e-02</span>    <span class="mf">2.13e-01</span>
   <span class="mi">6</span>  <span class="mf">6.520189e+00</span>    <span class="mf">4.10e-02</span>    <span class="mf">2.92e+01</span>   <span class="mf">5.26e+00</span>   <span class="mf">9.99e-01</span>  <span class="mf">7.29e+06</span>        <span class="mi">8</span>    <span class="mf">1.43e-02</span>    <span class="mf">2.28e-01</span>
   <span class="mi">7</span>  <span class="mf">6.506048e+00</span>    <span class="mf">1.41e-02</span>    <span class="mf">3.96e+00</span>   <span class="mf">1.42e+00</span>   <span class="mf">9.99e-01</span>  <span class="mf">2.19e+07</span>        <span class="mi">9</span>    <span class="mf">1.41e-02</span>    <span class="mf">2.42e-01</span>
   <span class="mi">8</span>  <span class="mf">6.505955e+00</span>    <span class="mf">9.28e-05</span>    <span class="mf">4.77e-02</span>   <span class="mf">1.43e-01</span>   <span class="mf">1.00e+00</span>  <span class="mf">6.56e+07</span>        <span class="mi">9</span>    <span class="mf">1.45e-02</span>    <span class="mf">2.56e-01</span>
<span class="n">Ceres</span> <span class="n">Solver</span> <span class="n">Report</span><span class="o">:</span> <span class="n">Iterations</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span> <span class="n">Initial</span> <span class="n">cost</span><span class="o">:</span> <span class="mf">1.606857e+02</span><span class="p">,</span> <span class="n">Final</span> <span class="n">cost</span><span class="o">:</span> <span class="mf">6.505955e+00</span><span class="p">,</span> <span class="n">Termination</span><span class="o">:</span> <span class="n">CONVERGENCE</span>
<span class="o">------</span> <span class="n">end</span> <span class="n">bundle</span> <span class="n">adjustment</span> <span class="o">------</span>
<span class="n">reprojection</span> <span class="n">error</span> <span class="p">(</span><span class="n">after</span> <span class="n">bundle</span> <span class="n">adjustment</span><span class="p">)</span><span class="o">:</span> <span class="mf">0.178282</span>
</code></pre>
</div>

<h3 id="9-sequential-sfm-">9. Sequential SfM <a name="nv_sfm"></a></h3>
<p>The sequential SfM can be summarized as follows:</p>
<ul>
  <li>merge two graphs</li>
  <li>N-view triangulation</li>
  <li>N-view bundle adjustment</li>
</ul>

<p>The code for N-view triangulation and N-view bundle adjustment are exactly the same as those of the 2-view counterparts. The main issue is to merge multiple pairwise graphs into a global graph containing all camera parameters, feature tracks, and 3D structure points.</p>

<h4 id="n-view-sfm">N-view SfM</h4>
<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="n">Graph</span> <span class="n">global_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nimages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"*******************************"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">" N-View SfM: merging graph 0-"</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"*******************************"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="c1">// ------ merge graphs ------
</span>    <span class="n">Graph</span><span class="o">::</span><span class="n">merge_graph</span><span class="p">(</span><span class="n">global_graph</span><span class="p">,</span> <span class="n">graph</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    
    <span class="c1">// ------ N-view triangulation ------
</span>    <span class="n">triangulate_nonlinear</span><span class="p">(</span><span class="n">global_graph</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">error</span> <span class="o">=</span> <span class="n">reprojection_error</span><span class="p">(</span><span class="n">global_graph</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"reprojection error (before bundle adjustment): "</span> <span class="o">&lt;&lt;</span> <span class="n">error</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    
    <span class="c1">// ------ N-view bundle adjustment ------
</span>    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"------ start bundle adjustment ------"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">Open3DCVBundleAdjustment</span><span class="p">(</span><span class="n">global_graph</span><span class="p">,</span> <span class="n">BUNDLE_PRINCIPAL_POINT</span><span class="p">);</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"------ end bundle adjustment ------"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">reprojection_error</span><span class="p">(</span><span class="n">global_graph</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"reprojection error (after bundle adjustment): "</span> <span class="o">&lt;&lt;</span> <span class="n">error</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="merge-graphs">Merge graphs</h4>
<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="n">Graph</span><span class="o">::</span><span class="n">merge_graph</span><span class="p">(</span><span class="n">Graph</span> <span class="o">&amp;</span><span class="n">graph1</span><span class="p">,</span> <span class="n">Graph</span> <span class="o">&amp;</span><span class="n">graph2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">iter</span><span class="p">;</span>
    
    <span class="c1">// find overlapping cameras
</span>    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">cams_common</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">graph1</span><span class="p">.</span><span class="n">ncams_</span><span class="p">,</span> <span class="n">graph2</span><span class="p">.</span><span class="n">ncams_</span><span class="p">));</span>
    <span class="n">iter</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">set_intersection</span><span class="p">(</span><span class="n">graph1</span><span class="p">.</span><span class="n">cams_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">graph1</span><span class="p">.</span><span class="n">cams_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">graph2</span><span class="p">.</span><span class="n">cams_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">graph2</span><span class="p">.</span><span class="n">cams_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">cams_common</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
    <span class="n">cams_common</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">iter</span> <span class="o">-</span> <span class="n">cams_common</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
    
    <span class="c1">// find distinct cameras
</span>    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">cams_diff</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">graph1</span><span class="p">.</span><span class="n">ncams_</span><span class="p">,</span> <span class="n">graph2</span><span class="p">.</span><span class="n">ncams_</span><span class="p">));</span>
    <span class="n">iter</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">set_difference</span><span class="p">(</span><span class="n">graph2</span><span class="p">.</span><span class="n">cams_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">graph2</span><span class="p">.</span><span class="n">cams_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">graph1</span><span class="p">.</span><span class="n">cams_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">graph1</span><span class="p">.</span><span class="n">cams_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">cams_diff</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
    <span class="n">cams_diff</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">iter</span> <span class="o">-</span> <span class="n">cams_diff</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">cams_common</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="c1">// merge the camera intrinsic and extrinsic parameters
</span>    <span class="kt">int</span> <span class="n">ind_cam1</span> <span class="o">=</span> <span class="n">graph1</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">cams_common</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="kt">int</span> <span class="n">ind_cam2</span> <span class="o">=</span> <span class="n">graph2</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">cams_common</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">Mat34f</span> <span class="n">Rt1</span> <span class="o">=</span> <span class="n">graph1</span><span class="p">.</span><span class="n">extrinsics_mat_</span><span class="p">[</span><span class="n">ind_cam1</span><span class="p">];</span>
    <span class="n">Mat34f</span> <span class="n">Rt2</span> <span class="o">=</span> <span class="n">graph2</span><span class="p">.</span><span class="n">extrinsics_mat_</span><span class="p">[</span><span class="n">ind_cam2</span><span class="p">];</span>
    <span class="n">Mat34f</span> <span class="n">Rt21</span> <span class="o">=</span> <span class="n">concat_Rt</span><span class="p">(</span><span class="n">inv_Rt</span><span class="p">(</span><span class="n">Rt1</span><span class="p">),</span> <span class="n">Rt2</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">graph2</span><span class="p">.</span><span class="n">structure_points_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Vec3f</span><span class="o">&amp;</span> <span class="n">pt3d</span> <span class="o">=</span> <span class="n">graph2</span><span class="p">.</span><span class="n">structure_points_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coords</span><span class="p">();</span>
        <span class="n">pt3d</span> <span class="o">=</span> <span class="n">Rt21</span> <span class="o">*</span> <span class="n">pt3d</span><span class="p">.</span><span class="n">homogeneous</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">Mat34f</span> <span class="n">Rt21t</span> <span class="o">=</span> <span class="n">inv_Rt</span><span class="p">(</span><span class="n">Rt21</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cams_diff</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">graph1</span><span class="p">.</span><span class="n">cams_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cams_diff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">graph1</span><span class="p">.</span><span class="n">intrinsics_mat_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">graph2</span><span class="p">.</span><span class="n">intrinsics_mat_</span><span class="p">[</span><span class="n">graph2</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">cams_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])]);</span>
        <span class="n">graph1</span><span class="p">.</span><span class="n">extrinsics_mat_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">concat_Rt</span><span class="p">(</span><span class="n">graph2</span><span class="p">.</span><span class="n">extrinsics_mat_</span><span class="p">[</span><span class="n">graph2</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">cams_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])],</span> <span class="n">Rt21t</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">graph1</span><span class="p">.</span><span class="n">ncams_</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">graph1</span><span class="p">.</span><span class="n">cams_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span> <span class="n">indexes</span><span class="p">;</span>
    <span class="n">sort</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">graph1</span><span class="p">.</span><span class="n">cams_</span><span class="p">,</span> <span class="n">graph1</span><span class="p">.</span><span class="n">cams_</span><span class="p">,</span> <span class="n">indexes</span><span class="p">);</span>
    <span class="n">reorder</span><span class="o">&lt;</span><span class="n">Mat3f</span><span class="o">&gt;</span><span class="p">(</span><span class="n">graph1</span><span class="p">.</span><span class="n">intrinsics_mat_</span><span class="p">,</span> <span class="n">indexes</span><span class="p">,</span> <span class="n">graph1</span><span class="p">.</span><span class="n">intrinsics_mat_</span><span class="p">);</span>
    <span class="n">reorder</span><span class="o">&lt;</span><span class="n">Mat34f</span><span class="o">&gt;</span><span class="p">(</span><span class="n">graph1</span><span class="p">.</span><span class="n">extrinsics_mat_</span><span class="p">,</span> <span class="n">indexes</span><span class="p">,</span> <span class="n">graph1</span><span class="p">.</span><span class="n">extrinsics_mat_</span><span class="p">);</span>
    
    <span class="k">const</span> <span class="kt">int</span> <span class="n">ntracks</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">graph1</span><span class="p">.</span><span class="n">tracks_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">graph2</span><span class="p">.</span><span class="n">tracks_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Track</span><span class="o">&amp;</span> <span class="n">track2</span> <span class="o">=</span> <span class="n">graph2</span><span class="p">.</span><span class="n">tracks_</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
        <span class="kt">bool</span> <span class="n">is_track_connected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ntracks</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Track</span><span class="o">&amp;</span> <span class="n">track1</span> <span class="o">=</span> <span class="n">graph1</span><span class="p">.</span><span class="n">tracks_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">feats_common</span><span class="p">;</span>
            <span class="n">Track</span><span class="o">::</span><span class="n">find_overlapping_keypoints</span><span class="p">(</span><span class="n">track1</span><span class="p">,</span> <span class="n">track2</span><span class="p">,</span> <span class="n">feats_common</span><span class="p">);</span>
            <span class="c1">// find overlapping feature tracks from common cameras
</span>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">feats_common</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">Graph</span><span class="o">::</span><span class="n">merge_tracks</span><span class="p">(</span><span class="n">track1</span><span class="p">,</span> <span class="n">track2</span><span class="p">,</span> <span class="n">feats_common</span><span class="p">);</span>
                <span class="n">is_track_connected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="c1">// check if the structur_points are close, for debug purpose
</span>                <span class="k">if</span> <span class="p">(</span><span class="nb">false</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"graph1 structure_point: "</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="n">graph1</span><span class="p">.</span><span class="n">structure_points_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coords</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
                    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"graph2 structure_point: "</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="n">graph2</span><span class="p">.</span><span class="n">structure_points_</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coords</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// find non-overlapping feature tracks from common cameras
</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_track_connected</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">graph1</span><span class="p">.</span><span class="n">add_track</span><span class="p">(</span><span class="n">track2</span><span class="p">);</span>
            <span class="n">graph1</span><span class="p">.</span><span class="n">add_struct_pt</span><span class="p">(</span><span class="n">graph2</span><span class="p">.</span><span class="n">structure_points_</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// find new features from non-overlapping cameras, this part is not needed for now
</span><span class="p">}</span>
</code></pre>
</div>

<h4 id="results">Results</h4>
<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="o">*******************************</span>
 <span class="n">N</span><span class="o">-</span><span class="n">View</span> <span class="n">SfM</span><span class="o">:</span> <span class="n">merging</span> <span class="n">graph</span> <span class="mi">0</span><span class="o">-</span><span class="mi">1</span>
<span class="o">*******************************</span>
<span class="n">reprojection</span> <span class="n">error</span> <span class="p">(</span><span class="n">before</span> <span class="n">bundle</span> <span class="n">adjustment</span><span class="p">)</span><span class="o">:</span> <span class="mf">1.76187</span>
<span class="o">------</span> <span class="n">start</span> <span class="n">bundle</span> <span class="n">adjustment</span> <span class="o">------</span>
<span class="n">iter</span>      <span class="n">cost</span>      <span class="n">cost_change</span>  <span class="o">|</span><span class="n">gradient</span><span class="o">|</span>   <span class="o">|</span><span class="n">step</span><span class="o">|</span>    <span class="n">tr_ratio</span>  <span class="n">tr_radius</span>  <span class="n">ls_iter</span>  <span class="n">iter_time</span>  <span class="n">total_time</span>
   <span class="mi">0</span>  <span class="mf">1.982806e+03</span>    <span class="mf">0.00e+00</span>    <span class="mf">2.31e+05</span>   <span class="mf">0.00e+00</span>   <span class="mf">0.00e+00</span>  <span class="mf">1.00e+04</span>        <span class="mi">0</span>    <span class="mf">7.02e-02</span>    <span class="mf">7.25e-02</span>
   <span class="p">[</span><span class="n">iterations</span> <span class="n">omitted</span><span class="p">]</span>
  <span class="mi">13</span>  <span class="mf">1.143924e+02</span>    <span class="mf">6.80e-03</span>    <span class="mf">1.26e+01</span>   <span class="mf">3.70e-01</span>   <span class="mf">9.99e-01</span>  <span class="mf">1.59e+10</span>        <span class="mi">9</span>    <span class="mf">8.41e-02</span>    <span class="mf">2.26e+00</span>
<span class="n">Ceres</span> <span class="n">Solver</span> <span class="n">Report</span><span class="o">:</span> <span class="n">Iterations</span><span class="o">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">Initial</span> <span class="n">cost</span><span class="o">:</span> <span class="mf">1.982806e+03</span><span class="p">,</span> <span class="n">Final</span> <span class="n">cost</span><span class="o">:</span> <span class="mf">1.143924e+02</span><span class="p">,</span> <span class="n">Termination</span><span class="o">:</span> <span class="n">CONVERGENCE</span>
<span class="o">------</span> <span class="n">end</span> <span class="n">bundle</span> <span class="n">adjustment</span> <span class="o">------</span>
<span class="n">reprojection</span> <span class="n">error</span> <span class="p">(</span><span class="n">after</span> <span class="n">bundle</span> <span class="n">adjustment</span><span class="p">)</span><span class="o">:</span> <span class="mf">0.340547</span>
<span class="o">*******************************</span>
 <span class="n">N</span><span class="o">-</span><span class="n">View</span> <span class="n">SfM</span><span class="o">:</span> <span class="n">merging</span> <span class="n">graph</span> <span class="mi">0</span><span class="o">-</span><span class="mi">2</span>
<span class="o">*******************************</span>
<span class="n">reprojection</span> <span class="n">error</span> <span class="p">(</span><span class="n">before</span> <span class="n">bundle</span> <span class="n">adjustment</span><span class="p">)</span><span class="o">:</span> <span class="mf">3.91939</span>
<span class="o">------</span> <span class="n">start</span> <span class="n">bundle</span> <span class="n">adjustment</span> <span class="o">------</span>
<span class="n">iter</span>      <span class="n">cost</span>      <span class="n">cost_change</span>  <span class="o">|</span><span class="n">gradient</span><span class="o">|</span>   <span class="o">|</span><span class="n">step</span><span class="o">|</span>    <span class="n">tr_ratio</span>  <span class="n">tr_radius</span>  <span class="n">ls_iter</span>  <span class="n">iter_time</span>  <span class="n">total_time</span>
   <span class="mi">0</span>  <span class="mf">1.464648e+04</span>    <span class="mf">0.00e+00</span>    <span class="mf">7.46e+05</span>   <span class="mf">0.00e+00</span>   <span class="mf">0.00e+00</span>  <span class="mf">1.00e+04</span>        <span class="mi">0</span>    <span class="mf">1.24e-01</span>    <span class="mf">1.32e-01</span>
   <span class="p">[</span><span class="n">iterations</span> <span class="n">omitted</span><span class="p">]</span>
  <span class="mi">34</span>  <span class="mf">1.442173e+02</span>    <span class="mf">2.78e-03</span>    <span class="mf">8.02e+00</span>   <span class="mf">3.16e+06</span>   <span class="mf">9.77e-01</span>  <span class="mf">1.00e+16</span>       <span class="mi">14</span>    <span class="mf">1.07e-01</span>    <span class="mf">8.95e+00</span>
<span class="n">Ceres</span> <span class="n">Solver</span> <span class="n">Report</span><span class="o">:</span> <span class="n">Iterations</span><span class="o">:</span> <span class="mi">34</span><span class="p">,</span> <span class="n">Initial</span> <span class="n">cost</span><span class="o">:</span> <span class="mf">1.464648e+04</span><span class="p">,</span> <span class="n">Final</span> <span class="n">cost</span><span class="o">:</span> <span class="mf">1.442173e+02</span><span class="p">,</span> <span class="n">Termination</span><span class="o">:</span> <span class="n">CONVERGENCE</span>
<span class="o">------</span> <span class="n">end</span> <span class="n">bundle</span> <span class="n">adjustment</span> <span class="o">------</span>
<span class="n">reprojection</span> <span class="n">error</span> <span class="p">(</span><span class="n">after</span> <span class="n">bundle</span> <span class="n">adjustment</span><span class="p">)</span><span class="o">:</span> <span class="mf">0.328052</span>
<span class="o">*******************************</span>
 <span class="n">N</span><span class="o">-</span><span class="n">View</span> <span class="n">SfM</span><span class="o">:</span> <span class="n">merging</span> <span class="n">graph</span> <span class="mi">0</span><span class="o">-</span><span class="mi">3</span>
<span class="o">*******************************</span>
<span class="n">reprojection</span> <span class="n">error</span> <span class="p">(</span><span class="n">before</span> <span class="n">bundle</span> <span class="n">adjustment</span><span class="p">)</span><span class="o">:</span> <span class="mf">4.75183</span>
<span class="o">------</span> <span class="n">start</span> <span class="n">bundle</span> <span class="n">adjustment</span> <span class="o">------</span>
<span class="n">iter</span>      <span class="n">cost</span>      <span class="n">cost_change</span>  <span class="o">|</span><span class="n">gradient</span><span class="o">|</span>   <span class="o">|</span><span class="n">step</span><span class="o">|</span>    <span class="n">tr_ratio</span>  <span class="n">tr_radius</span>  <span class="n">ls_iter</span>  <span class="n">iter_time</span>  <span class="n">total_time</span>
   <span class="mi">0</span>  <span class="mf">5.316645e+04</span>    <span class="mf">0.00e+00</span>    <span class="mf">3.86e+05</span>   <span class="mf">0.00e+00</span>   <span class="mf">0.00e+00</span>  <span class="mf">1.00e+04</span>        <span class="mi">0</span>    <span class="mf">1.27e-01</span>    <span class="mf">1.33e-01</span>
   <span class="p">[</span><span class="n">iterations</span> <span class="n">omitted</span><span class="p">]</span>
  <span class="mi">26</span>  <span class="mf">1.586235e+02</span>    <span class="mf">3.25e-03</span>    <span class="mf">1.79e+01</span>   <span class="mf">4.73e+06</span>   <span class="mf">9.11e-01</span>  <span class="mf">5.93e+13</span>       <span class="mi">25</span>    <span class="mf">1.35e-01</span>    <span class="mf">9.55e+00</span>
<span class="n">Ceres</span> <span class="n">Solver</span> <span class="n">Report</span><span class="o">:</span> <span class="n">Iterations</span><span class="o">:</span> <span class="mi">26</span><span class="p">,</span> <span class="n">Initial</span> <span class="n">cost</span><span class="o">:</span> <span class="mf">5.316645e+04</span><span class="p">,</span> <span class="n">Final</span> <span class="n">cost</span><span class="o">:</span> <span class="mf">1.586235e+02</span><span class="p">,</span> <span class="n">Termination</span><span class="o">:</span> <span class="n">CONVERGENCE</span>
<span class="o">------</span> <span class="n">end</span> <span class="n">bundle</span> <span class="n">adjustment</span> <span class="o">------</span>
<span class="n">reprojection</span> <span class="n">error</span> <span class="p">(</span><span class="n">after</span> <span class="n">bundle</span> <span class="n">adjustment</span><span class="p">)</span><span class="o">:</span> <span class="mf">0.321569</span>
</code></pre>
</div>

<h3 id="10-output-">10. Output <a name="output"></a></h3>

  </article>

  

  

</div>

      </div>
    </div>

    <footer>

  <div class="wrapper">
    &copy; Copyright 2017 Kai Wu.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.

    
  </div>

</footer>


    <!-- Load jQuery -->
<script src="//code.jquery.com/jquery-1.12.4.min.js"></script>

<!-- Load Common JS -->
<script src="//imkaywu.github.io/assets/js/common.js"></script>





<!-- Include custom icon fonts -->
<link rel="stylesheet" href="//imkaywu.github.io/assets/css/font-awesome.min.css">
<link rel="stylesheet" href="//imkaywu.github.io/assets/css/academicons.min.css">

<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-XXXXXXXX-X', 'auto');
ga('send', 'pageview');
</script>


  </body>

</html>
