<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Kai Wu | Estimation of fundamental matrix</title>
  <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design.
">

  <link rel="shortcut icon" href="https://imkaywu.github.io/assets/img/favicon.ico">
  <link rel="stylesheet" href="https://imkaywu.github.io/assets/css/main.css">
  <link rel="canonical" href="https://imkaywu.github.io/blog/2017/06/fundamental-matrix/">

  
</head>

  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML'></script>

  <body>

    <header class="site-header">

  <div class="wrapper">

    
    <span class="site-title">
        
        <strong>Kai</strong> Wu
    </span>
    

    <nav class="site-nav">

      <div class="trigger">
        <!-- About -->
        <a class="page-link" href="https://imkaywu.github.io/">about</a>

        <!-- Blog -->
        <a class="page-link" href="https://imkaywu.github.io/blog/">blog</a>

        <!-- Pages -->
        
          
        
          
            <a class="page-link" href="https://imkaywu.github.io/code/">code</a>
          
        
          
        
          
            <a class="page-link" href="https://imkaywu.github.io/links/">links</a>
          
        
          
        
          
            <a class="page-link" href="https://imkaywu.github.io/projects/">projects</a>
          
        
          
            <a class="page-link" href="https://imkaywu.github.io/tutorials/">tutorials</a>
          
        
          
        
          
        
          
        
          
        

        <!-- CV link -->
        <!-- <a class="page-link" href="https://imkaywu.github.io/assets/pdf/CV.pdf">vitae</a> -->

      </div>
    </nav>

  </div>

</header>



    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Estimation of fundamental matrix</h1>
    <p class="post-meta">June 11, 2017</p>
  </header>

  <article class="post-content">
    <p>The epipolar geometry is the intrinsic projective geometry between two views, which is independent of scene structure, and only depends on the camera’s internal parameters and relative pose.</p>

<p>The fundamental matrix <script type="math/tex">F</script> encapsulates this intrinsic geometry, which is a <script type="math/tex">3\times 3</script> matrix of rank 2. If a 3D point <script type="math/tex">X</script> is projected as <script type="math/tex">\mathbf{x}</script> in the first view, and <script type="math/tex">\mathbf{x'}</script> in the second, then we have the following relation</p>

<script type="math/tex; mode=display">x'Fx = 0</script>

<p>Each point correspondence gives rise to one linear equation. Specifically, writing <script type="math/tex">\mathbf{x}=(x, y, 1)</script>, and <script type="math/tex">\mathbf{x'}=(x', y', 1)</script>, this equation can be written in terms of the known coordinates <script type="math/tex">x</script> and <script type="math/tex">x'</script>.</p>

<script type="math/tex; mode=display">x'xf_{11}+x'yf_{12}+x'f_{13}+y'xf_{21}+y'yf_{22}+y'f_{23}+xf_{31}+yf_{32}+f_{33}=0</script>

<p>where <script type="math/tex">f_{ij}</script> is the component of <script type="math/tex">F</script> in <script type="math/tex">(i,j)</script> position. Organize all <script type="math/tex">f_{ij}</script> into the vector <script type="math/tex">\mathbf{f}</script>, we have</p>

<script type="math/tex; mode=display">\left[x'x, x'y, x', y'x, y'y, y', x, y, 1\right]\mathbf{f}=0</script>

<p>From a set of <script type="math/tex">n</script> point correspondences, we obtain a set of linear equations of the form</p>

<script type="math/tex; mode=display">Af = \begin{bmatrix}
x_1'x_1, x'_1y_1, x_1', y_1'x_1, y_1'y_1, y_1', x_1, y_1, 1\\
\vdots\\
x_n'x_n, x_n'y_n, x_n', y_n'x_n, y_n'y_n, y_n', x_n, y_n, 1\\
\end{bmatrix} \mathbf{f} = \mathbf{0}.</script>

<h3 id="fundamental-matrix-from-seven-point-correspondences">Fundamental matrix from seven point correspondences</h3>
<p>If <script type="math/tex">A</script> has rank 8, then it is possible to solve for <script type="math/tex">f</script> up to scale. In the case where <script type="math/tex">A</script> has rank 7, it is still possible to solve for fundamental matrix by using the singularity constraint. The reason is that fundamental matrix has only seven degrees of freedom since it is defined up to a scale and <script type="math/tex">det(F)=0</script>.</p>

<p>Since <script type="math/tex">A</script> is a <script type="math/tex">n\times 9</script> matrix and is of rank 7, the dimension of the nullspace is 2. Let’s denote these two nullspace by <script type="math/tex">f_1</script> and <script type="math/tex">f_2</script>, their correponding fundamental matrices are <script type="math/tex">F_1</script> and <script type="math/tex">F_2</script>. The solution to <script type="math/tex">Af=0</script> is a 2-dimensional space of the form <script type="math/tex">aF_1+(1-a)F_2</script>, where <script type="math/tex">a</script> is a scalar. We then use the singular constraint that <script type="math/tex">det(F)=0</script>, which leads to a cubic polynomial equation of <script type="math/tex">a</script> since <script type="math/tex">F_1</script> and <script type="math/tex">F_2</script> are already known. Solving this polynomial equation might lead to one or three real solutions. This method is called seven point algorithm, and returns one or three fundamental matrices.</p>

<h3 id="fundamental-matrix-from-eight-point-correspondences">Fundamental matrix from eight point correspondences</h3>
<p>The least squares solution for <script type="math/tex">\mathbf{f}</script> is the singular vector corresponding to the smallest singular value of <script type="math/tex">A</script>, that is, the last column of <script type="math/tex">V</script> in the SVD <script type="math/tex">A=UDV^\top</script>. The solution minimizes the algebraic error <script type="math/tex">\|A\mathbf{f}\|</script> subject to <script type="math/tex">\|\mathbf{f}\|=1</script>. This algorithm is call “8-point” algorithm.</p>

<p>To make algorithm perform better, we typically need to do a normalization step: the center of the points are moved to the origin, and the RMS distance of the points to the origin is <script type="math/tex">\sqrt{2}</script>.</p>

<p>Peter Kovesi implemented an amazing <a href="http://www.peterkovesi.com/matlabfns/#projective">projective geometry</a> library in Matlab, including estimation of the fundamental matrix.</p>

<h3 id="7-point-algorithm-c-version">7-point algorithm: C++ version</h3>
<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="n">Fundamental_Estimator</span><span class="o">::</span><span class="n">fund_seven_pts</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="o">&gt;&amp;</span> <span class="n">x1</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="o">&gt;&amp;</span> <span class="n">x2</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Mat3f</span><span class="o">&gt;&amp;</span> <span class="n">F</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x1</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">7</span> <span class="o">||</span> <span class="n">x2</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Wrong size of input points."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
<span class="c1">//    vector&lt;Vec2f&gt; nx1, nx2;
//    Mat3f T1, T2;
//    T1 = normalize_pts&lt;Vec2f&gt;(x1, nx1);
//    T2 = normalize_pts&lt;Vec2f&gt;(x2, nx2);
</span>    
    <span class="n">Mat2Xf</span> <span class="n">matx1</span><span class="p">,</span> <span class="n">matx2</span><span class="p">;</span>
    <span class="n">vector2mat</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="p">,</span> <span class="n">Mat2Xf</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">matx1</span><span class="p">);</span>
    <span class="n">vector2mat</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="p">,</span> <span class="n">Mat2Xf</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">matx2</span><span class="p">);</span>

    <span class="c1">// construct the A matrix in Af = 0
</span>    <span class="n">Matf</span> <span class="n">A</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
    <span class="n">A</span> <span class="o">&lt;&lt;</span> <span class="n">matx2</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">array</span><span class="p">()</span> <span class="o">*</span> <span class="n">matx1</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">array</span><span class="p">(),</span>
         <span class="n">matx2</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">array</span><span class="p">()</span> <span class="o">*</span> <span class="n">matx1</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">array</span><span class="p">(),</span>
         <span class="n">matx2</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">array</span><span class="p">(),</span>
         <span class="n">matx2</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">array</span><span class="p">()</span> <span class="o">*</span> <span class="n">matx1</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">array</span><span class="p">(),</span>
         <span class="n">matx2</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">array</span><span class="p">()</span> <span class="o">*</span> <span class="n">matx1</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">array</span><span class="p">(),</span>
         <span class="n">matx2</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">array</span><span class="p">(),</span>
         <span class="n">matx1</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">array</span><span class="p">(),</span>
         <span class="n">matx1</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">array</span><span class="p">(),</span>
         <span class="n">Matf</span><span class="o">::</span><span class="n">Ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">.</span><span class="n">transpose</span><span class="p">().</span><span class="n">eval</span><span class="p">();</span> <span class="c1">// transposeInPlace();
</span>    
    <span class="c1">// solving for nullspace of A to get two F
</span>    <span class="n">JacobiSVD</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Dynamic</span><span class="p">,</span> <span class="mi">9</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">amatrix_svd</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullV</span><span class="p">);</span>
    <span class="n">Vec9f</span> <span class="n">fvec1</span> <span class="o">=</span> <span class="n">amatrix_svd</span><span class="p">.</span><span class="n">matrixV</span><span class="p">().</span><span class="n">col</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
    <span class="n">Vec9f</span> <span class="n">fvec2</span> <span class="o">=</span> <span class="n">amatrix_svd</span><span class="p">.</span><span class="n">matrixV</span><span class="p">().</span><span class="n">col</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
    
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">Mat3f</span><span class="o">&gt;</span> <span class="n">Fmat</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">Fmat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">fvec1</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fvec1</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">fvec1</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
               <span class="n">fvec1</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">fvec1</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">fvec1</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
               <span class="n">fvec1</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">fvec1</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">fvec1</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
    
    <span class="n">Fmat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">fvec2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fvec2</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">fvec2</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
               <span class="n">fvec2</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">fvec2</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">fvec2</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
               <span class="n">fvec2</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">fvec2</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">fvec2</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
    
    <span class="c1">// find F that meets the singularity constraint: det(a * F1 + (1 - a) * F2) = 0
</span>    <span class="kt">float</span> <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i1</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i2</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i2</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i3</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i3</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Mat3f</span> <span class="n">Dtmp</span><span class="p">;</span>
                <span class="n">Dtmp</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">Fmat</span><span class="p">[</span><span class="n">i1</span><span class="p">].</span><span class="n">col</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="n">Dtmp</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">Fmat</span><span class="p">[</span><span class="n">i2</span><span class="p">].</span><span class="n">col</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                <span class="n">Dtmp</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">Fmat</span><span class="p">[</span><span class="n">i3</span><span class="p">].</span><span class="n">col</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
                <span class="n">D</span><span class="p">[</span><span class="n">i1</span><span class="p">][</span><span class="n">i2</span><span class="p">][</span><span class="n">i3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dtmp</span><span class="p">.</span><span class="n">determinant</span><span class="p">();</span>
            <span class="p">}</span>
    
    <span class="c1">// solving cubic equation and getting 1 or 3 solutions for F
</span>    <span class="n">Vec</span> <span class="n">coefficients</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">coefficients</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">coefficients</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">coefficients</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">coefficients</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    
    <span class="n">Vec</span> <span class="n">roots</span><span class="p">;</span>
    <span class="n">rpoly_plus_plus</span><span class="o">::</span><span class="n">FindPolynomialRootsJenkinsTraub</span><span class="p">(</span><span class="n">coefficients</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">roots</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    
    <span class="c1">// check sign consistency
</span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">roots</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Mat3f</span> <span class="n">Ftmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">roots</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fmat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">roots</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">*</span> <span class="n">Fmat</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">JacobiSVD</span><span class="o">&lt;</span><span class="n">Mat3f</span><span class="o">&gt;</span> <span class="n">fmatrix_svd</span><span class="p">(</span><span class="n">Ftmp</span><span class="p">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullV</span><span class="p">);</span>
        <span class="n">Vec3f</span> <span class="n">e1</span> <span class="o">=</span> <span class="n">fmatrix_svd</span><span class="p">.</span><span class="n">matrixV</span><span class="p">().</span><span class="n">col</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">Mat3Xf</span> <span class="n">l1_ex</span> <span class="o">=</span> <span class="n">CrossProductMatrix</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span> <span class="o">*</span> <span class="n">matx1</span><span class="p">.</span><span class="n">colwise</span><span class="p">().</span><span class="n">homogeneous</span><span class="p">();</span> <span class="c1">// lines connecting of x1 and e1
</span>        <span class="n">Mat3Xf</span> <span class="n">l1_Fx</span> <span class="o">=</span> <span class="n">Ftmp</span> <span class="o">*</span> <span class="n">matx2</span><span class="p">.</span><span class="n">colwise</span><span class="p">().</span><span class="n">homogeneous</span><span class="p">();</span> <span class="c1">// lines determined by F and x2
</span>        <span class="n">Vecf</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1_Fx</span><span class="p">.</span><span class="n">array</span><span class="p">()</span> <span class="o">*</span> <span class="n">l1_ex</span><span class="p">.</span><span class="n">array</span><span class="p">()).</span><span class="n">colwise</span><span class="p">().</span><span class="n">sum</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="p">.</span><span class="n">array</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">).</span><span class="n">all</span><span class="p">()</span> <span class="o">||</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">array</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">).</span><span class="n">all</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">F</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Ftmp</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="8-point-algorithm-c-version">8-point algorithm: C++ version</h3>
<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fund_eight_pts</span> <span class="p">(</span><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="o">&gt;&amp;</span> <span class="n">x1</span><span class="p">,</span> <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="o">&gt;&amp;</span> <span class="n">x2</span><span class="p">,</span> <span class="n">Mat3f</span><span class="o">&amp;</span> <span class="n">F</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="o">&gt;</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">nx2</span><span class="p">;</span>
    <span class="n">Mat3f</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">;</span>
    <span class="n">T1</span> <span class="o">=</span> <span class="n">normalize_pts</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">nx1</span><span class="p">);</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">normalize_pts</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">nx2</span><span class="p">);</span>
    
    <span class="n">Matf</span> <span class="n">matx1</span><span class="p">,</span> <span class="n">matx2</span><span class="p">;</span>
    <span class="n">vector2mat</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nx1</span><span class="p">,</span> <span class="n">matx1</span><span class="p">);</span>
    <span class="n">vector2mat</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nx2</span><span class="p">,</span> <span class="n">matx2</span><span class="p">);</span>
    
    <span class="n">Matf</span> <span class="n">A</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">x1</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">A</span> <span class="o">&lt;&lt;</span> <span class="n">matx2</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">array</span><span class="p">()</span> <span class="o">*</span> <span class="n">matx1</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">array</span><span class="p">(),</span>
         <span class="n">matx2</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">array</span><span class="p">()</span> <span class="o">*</span> <span class="n">matx1</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">array</span><span class="p">(),</span>
         <span class="n">matx2</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">array</span><span class="p">(),</span>
         <span class="n">matx2</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">array</span><span class="p">()</span> <span class="o">*</span> <span class="n">matx1</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">array</span><span class="p">(),</span>
         <span class="n">matx2</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">array</span><span class="p">()</span> <span class="o">*</span> <span class="n">matx1</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">array</span><span class="p">(),</span>
         <span class="n">matx2</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">array</span><span class="p">(),</span>
         <span class="n">matx1</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
         <span class="n">matx1</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
         <span class="n">Matf</span><span class="o">::</span><span class="n">Ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x1</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">.</span><span class="n">transpose</span><span class="p">().</span><span class="n">eval</span><span class="p">();</span>
    
    <span class="c1">// Solve the constraint equation for F from nullspace extraction.
</span>    <span class="c1">// An LU decomposition is efficient for the minimally constrained case.
</span>    <span class="c1">// Otherwise, use an SVD.
</span>    <span class="n">Vec9f</span> <span class="n">fvector</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// x1.size() == 8
</span>    <span class="p">{</span>
        <span class="k">const</span> <span class="k">auto</span> <span class="n">lu_decomp</span> <span class="o">=</span> <span class="n">A</span><span class="p">.</span><span class="n">fullPivLu</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">lu_decomp</span><span class="p">.</span><span class="n">dimensionOfKernel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">fvector</span> <span class="o">=</span> <span class="n">lu_decomp</span><span class="p">.</span><span class="n">kernel</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">JacobiSVD</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Dynamic</span><span class="p">,</span> <span class="mi">9</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">amatrix_svd</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullV</span><span class="p">);</span>
        <span class="n">fvector</span> <span class="o">=</span> <span class="n">amatrix_svd</span><span class="p">.</span><span class="n">matrixV</span><span class="p">().</span><span class="n">col</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="n">F</span> <span class="o">&lt;&lt;</span> <span class="n">fvector</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fvector</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">fvector</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
         <span class="n">fvector</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">fvector</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">fvector</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
         <span class="n">fvector</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">fvector</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">fvector</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
    
    <span class="c1">// enforce the constraint that F is of rank 2
</span>    <span class="c1">// Find the closest singular matrix to F under frobenius norm.
</span>    <span class="c1">// We can compute this matrix with SVD.
</span>    <span class="n">JacobiSVD</span><span class="o">&lt;</span><span class="n">Mat3f</span><span class="o">&gt;</span> <span class="n">fmatrix_svd</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullU</span> <span class="o">|</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullV</span><span class="p">);</span>
    <span class="n">Vec3f</span> <span class="n">singular_values</span> <span class="o">=</span> <span class="n">fmatrix_svd</span><span class="p">.</span><span class="n">singularValues</span><span class="p">();</span>
    <span class="n">singular_values</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">fmatrix_svd</span><span class="p">.</span><span class="n">matrixU</span><span class="p">()</span> <span class="o">*</span> <span class="n">singular_values</span><span class="p">.</span><span class="n">asDiagonal</span><span class="p">()</span> <span class="o">*</span> <span class="n">fmatrix_svd</span><span class="p">.</span><span class="n">matrixV</span><span class="p">().</span><span class="n">transpose</span><span class="p">();</span>

    <span class="n">F</span> <span class="o">=</span> <span class="n">T2</span><span class="p">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">F</span> <span class="o">*</span> <span class="n">T1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="normalization-c-version">normalization: C++ version</h3>
<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="kr">inline</span> <span class="n">Mat3f</span> <span class="nf">normalize_pts</span><span class="p">(</span><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="o">&gt;&amp;</span> <span class="n">pts</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Vec2f</span><span class="o">&gt;&amp;</span> <span class="n">newpts</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">newpts</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">pts</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">Vec2f</span> <span class="n">c</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pts</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="n">pts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">c</span> <span class="o">/=</span> <span class="n">pts</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    
    <span class="kt">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pts</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">newpts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">;</span>
        <span class="n">dist</span> <span class="o">+=</span> <span class="n">newpts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">norm</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">dist</span> <span class="o">/=</span> <span class="n">pts</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    
    <span class="kt">float</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">dist</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pts</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">newpts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">Mat3f</span> <span class="n">T</span><span class="p">;</span>
    <span class="n">T</span> <span class="o">&lt;&lt;</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>     <span class="o">-</span><span class="n">scale</span> <span class="o">*</span> <span class="n">c</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
         <span class="mi">0</span><span class="p">,</span>     <span class="n">scale</span><span class="p">,</span> <span class="o">-</span><span class="n">scale</span> <span class="o">*</span> <span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
         <span class="mi">0</span><span class="p">,</span>     <span class="mi">0</span><span class="p">,</span>      <span class="mi">1</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="n">T</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="fundamental-matrix-from-transfer-matrix">Fundamental matrix from transfer matrix</h3>
<div class="img_row">
    <img class="col three" src="/assets/img/open3DCV/fundamental/epipolar_geometry.png" alt="" title="epipolar geometry" />
</div>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
l'&=e'\times x'\\
&=e'\times H_\pi x\\
&=Fx
\end{align} %]]></script>

<p>Therefore, the fundamental matrix can be defined as</p>

<script type="math/tex; mode=display">F = e'\times H_\pi</script>

<h3 id="fundamental-matrix-from-projection-matrices">Fundamental matrix from projection matrices</h3>

<p>The epipolar line in the second view of an image point <script type="math/tex">x</script> is the projection of the ray passing through camera center of the first view and <script type="math/tex">x</script>. The ray can be parameterized as</p>

<script type="math/tex; mode=display">\mathbf{X}(\lambda)=P^{+}\mathbf{x}+\lambda \mathbf{C}</script>

<p>where <script type="math/tex">P</script> is the projection matrix of the first view. Two special points on this ray is the camera center <script type="math/tex">C</script> and <script type="math/tex">P^{+}x</script>. These two points are imaged by the second camera <script type="math/tex">P'</script> at <script type="math/tex">P'C</script> and <script type="math/tex">P'P^{+}x</script>. The epipolar line is the line joining these two projected points, namely <script type="math/tex">l'=P'C \times P'P^{+}x</script>. Since the projection of the first camera center onto the second view is the epipole, the line is also <script type="math/tex">l'=e'\times P'P^{+}x</script>, and <script type="math/tex">F</script> can be defined as</p>

<script type="math/tex; mode=display">F=P'P^{+}</script>

<p>We can further claim that the transfer matrix <script type="math/tex">H_\pi = e'\times P'P^{+}</script>.</p>

<h3 id="essential-matrix">Essential Matrix</h3>

  </article>

  

</div>

      </div>
    </div>

    <footer>

  <div class="wrapper">
    &copy; Copyright 2018 Kai Wu.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.

    
  </div>

</footer>


    <!-- Load jQuery -->
<script src="//code.jquery.com/jquery-1.12.4.min.js"></script>

<!-- Load Common JS -->
<script src="https://imkaywu.github.io/assets/js/common.js"></script>





<!-- Include custom icon fonts -->
<link rel="stylesheet" href="https://imkaywu.github.io/assets/css/font-awesome.min.css">
<link rel="stylesheet" href="https://imkaywu.github.io/assets/css/academicons.min.css">

<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-XXXXXXXX-X', 'auto');
ga('send', 'pageview');
</script>


  </body>

</html>
