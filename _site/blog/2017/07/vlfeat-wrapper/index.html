<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Kai Wu | VLFeat wrapper</title>
  <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design.
">

  <link rel="shortcut icon" href="//imkaywu.github.io/assets/img/favicon.ico">

  <link rel="stylesheet" href="//imkaywu.github.io/assets/css/main.css">
  <link rel="canonical" href="//imkaywu.github.io/blog/2017/07/vlfeat-wrapper/">
</head>

  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML'></script>

  <body>

    <header class="site-header">

  <div class="wrapper">

    
    <span class="site-title">
        
        <strong>Kai</strong> Wu
    </span>
    

    <nav class="site-nav">

      <div class="trigger">
        <!-- About -->
        <a class="page-link" href="//imkaywu.github.io/">about</a>

        <!-- Blog -->
        <a class="page-link" href="//imkaywu.github.io/blog/">blog</a>

        <!-- Pages -->
        
          
        
          
            <a class="page-link" href="//imkaywu.github.io/code/">code</a>
          
        
          
        
          
            <a class="page-link" href="//imkaywu.github.io/links/">links</a>
          
        
          
        
          
            <a class="page-link" href="//imkaywu.github.io/projects/">projects</a>
          
        
          
            <a class="page-link" href="//imkaywu.github.io/tutorials/">collections</a>
          
        
          
        
          
        
          
        

        <!-- CV link -->
        <!-- <a class="page-link" href="//imkaywu.github.io/assets/pdf/CV.pdf">vitae</a> -->

      </div>
    </nav>

  </div>

</header>



    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">VLFeat wrapper</h1>
    <p class="post-meta">July 22, 2017</p>
  </header>

  <article class="post-content">
    <p>The keypoint detector and descriptor classes implemented are a wrapper of the amazing <a href="http://www.vlfeat.org">vlfeat</a> functionalities. There are three separated classes, they are:</p>

<ul>
  <li>Keypoint
    <ul>
      <li>member variables: coords_, scale_, orientation_, index_, color_, keypoint_type_</li>
      <li>member methods: setters/getters</li>
    </ul>
  </li>
  <li>Detector
    <ul>
      <li>detect_keypoints</li>
    </ul>
  </li>
  <li>Descriptor
    <ul>
      <li>extract_descriptor;</li>
    </ul>
  </li>
</ul>

<p>The specific keypoint class is the subclass of both <code class="highlighter-rouge">Detector</code> and <code class="highlighter-rouge">Descriptor</code>.</p>

<h3 id="results-of-detector">Results of Detector</h3>
<div class="img_row">
    <img class="col one" src="/assets/img/open3DCV/keypoint/sift_pgm.pgm" alt="sift detector" title="sift detector" />
    <img class="col two" src="/assets/img/open3DCV/keypoint/sift_jpg.jpg" alt="sift detector" title="sift detector" />
</div>
<div class="col three caption">
    Detection results returned by the implemented C++ wrapper
</div>

<div class="img_row">
    <img class="col one" src="/assets/img/open3DCV/keypoint/sift_pgm_mat.jpg" alt="sift detector" title="sift detector" />
    <img class="col two" src="/assets/img/open3DCV/keypoint/sift_jpg_mat.jpg" alt="sift detector" title="sift detector" />
</div>
<div class="col three caption">
    Detection results returned by the SIFT Mex file
</div>

<h3 id="results-of-matching">Results of Matching</h3>
<div class="img_row">
    <img class="col three" src="/assets/img/open3DCV/keypoint/matching_0.pgm" alt="sift detector" title="sift detector" />
</div>
<div class="img_row">
    <img class="col three" src="/assets/img/open3DCV/keypoint/matching_1.pgm" alt="sift detector" title="sift detector" />
</div>
<div class="img_row">
    <img class="col three" src="/assets/img/open3DCV/keypoint/matching_2.pgm" alt="sift detector" title="sift detector" />
</div>
<div class="col three caption">
    SIFT feature matching results returned by the implemented C++ wrapper
</div>

<h3 id="keypoint-class-header-file"><code class="highlighter-rouge">Keypoint</code> class: header file</h3>
<p>The header file of the <code class="highlighter-rouge">Keypoint</code> class</p>
<div class="highlighter-rouge"><pre class="highlight"><code>#ifndef keypoint_h
#define keypoint_h

#include "numeric.h"

namespace open3DCV {
    //! Keypoint class
    /*!
     * This class encapsulates the data associated with a 2D image keypoint.
     * This class stores the x and y coordinates of the image location, along
     * with the index (i) of the image (camera) it is found, and color value
     * (stored in a 0-255 format).
     */
    enum KeypointType
    {
        INVALID = -1,
        DOG = 0,
        HARRIS = 1,
        SIFT = 2,
        SURF = 3,
    };
    
    class Keypoint {
    public:
        Keypoint(const Vec2 &amp;r_x, KeypointType &amp;r_t);
        Keypoint(const Vec2 &amp;r_x, KeypointType &amp;r_t, unsigned int r_i);
        Keypoint(const Vec2 &amp;r_x, KeypointType &amp;r_t, unsigned int r_i, const Vec3i &amp;r_c);
        virtual ~Keypoint() { };
        
        const Vec2 &amp;coords() const;
        void coords(const Vec2 r_coords);
        const unsigned int index() const;
        void index(const unsigned int r_i);
        const Vec3i &amp;color() const;
        void color(const Vec3i r_c);
        const double scale() const;
        void scale(const double r_s);
        const double orientation() const;
        void orientation(const double r_o);

    private:
        Vec2 coords_;                   // coordinates
        unsigned int index_;            // Image index
        Vec3i color_;                   // color
        KeypointType keypoint_type_;
        double scale_;
        double orientation_;
        
    };
    // inline code
}
#endif // keypoint_h

</code></pre>
</div>

<h3 id="detector-class-header-file"><code class="highlighter-rouge">Detector</code> class: header file</h3>
<p>The header file of the <code class="highlighter-rouge">Detector</code></p>
<div class="highlighter-rouge"><pre class="highlight"><code>#ifndef detector_h_
#define detector_h_

#include "image/image.h"
#include "keypoint/keypoint.h"

namespace open3DCV {
    class Detector {
    public:
        Detector();
        virtual ~Detector();
        
        virtual int detect_keypoints(const Image&amp; image, vector&lt;Keypoint&gt;&amp; keypoints);
    };
} // namespace open3DCV

#endif
</code></pre>
</div>

<h3 id="descriptor-class-header-file"><code class="highlighter-rouge">Descriptor</code> class: header file</h3>
<div class="highlighter-rouge"><pre class="highlight"><code>#ifndef descriptor_h_
#define descriptor_h_

#include "math/numeric.h"
#include "image/image.h"
#include "keypoint/keypoint.h"

namespace open3DCV {
    class Descriptor {
    public:
        Descriptor() { };
        virtual ~Descriptor() { };
        
        virtual int extract_descriptor(const Image&amp; image, const Keypoint&amp; keypoint, Vecf&amp; descriptor) = 0;
        virtual int extract_descriptors(const Image&amp; image, vector&lt;Keypoint&gt;&amp; keypoints, vector&lt;Vecf&gt;&amp; descriptors);
    };
    
    // If any descriptors could not be extracted at a given keypoint, that keypoint would be removed from the container
    inline int Descriptor::extract_descriptors(const Image&amp; image, vector&lt;Keypoint&gt;&amp; keypoints, vector&lt;Vecf&gt;&amp; descriptors)
    {
        descriptors.reserve(keypoints.size());
        
        auto keypoint_it = keypoints.begin();
        while (keypoint_it != keypoints.end())
        {
            Vecf descriptor;
            if (!extract_descriptor(image, *keypoint_it, descriptor))
            {
                keypoint_it = keypoints.erase(keypoint_it);
                continue;
            }
            descriptors.push_back(descriptor);
        }
        return 0;
    }
} // namespace open3DCV

#endif

</code></pre>
</div>

<h3 id="sift-detector-class-header-file"><code class="highlighter-rouge">Sift</code> detector class: header file</h3>
<p>The header file</p>
<div class="highlighter-rouge"><pre class="highlight"><code>#ifndef sift_h_
#define sift_h_

#include "vl/sift.h"
#include "keypoint/keypoint.h"
#include "keypoint/detector.h"
#include "keypoint/descriptor.h"

namespace open3DCV {

class Sift_Params {
    
};

class Sift : public Detector, public Descriptor {
    
public:
    
    Sift() { type_ = SIFT };
    ~Sift() { delete data_; };
    
    int convert(Image &amp;img);
    int detect_keypoints(const Image &amp;image, vector&lt;Keypoint&gt; &amp;keypoints, int verbose);
    int extract_descript();
    void transpose_descriptor (vl_sift_pix* dst, vl_sift_pix* src);
    static bool ksort(const Keypoint &amp;a, const Keypoint &amp;b);
    vl_bool check_sorted(const vector&lt;Keypoint&gt; &amp;keys, vl_size nkeys);
    
private:
    vl_sift_pix* data_;
    int width_, height_, channel_;
    KeypointType type_;
    
}; // end of class Sift

} // end of namespace open3DCV

#endif // sift_h

</code></pre>
</div>

<h3 id="sift-detector-class-implementation-file"><code class="highlighter-rouge">Sift</code> detector class: implementation file</h3>
<div class="highlighter-rouge"><pre class="highlight"><code>int Sift::detect_keypoints_simp(Image &amp;image, vector&lt;Keypoint&gt; &amp;keypoints, int verbose)
{
    // convert image
    convert(image);
    
    // sift setting
    int O = 3;
    int S = 3;
    int o_min = 0;
    double edge_thresh = 10;
    double peak_thresh = 0;
    double norm_thresh = -INFINITY;
    double magnif = 3;
    double window_size = 2;
    
    VlSiftFilt* filt = 0;
    
    if (filt == nullptr || (filt-&gt;width != image.width() ||
                            filt-&gt;height != image.height()))
    {
        vl_sift_delete(filt);
        filt = vl_sift_new(image.width(), image.height(),
                           O, S, o_min);
        vl_sift_set_edge_thresh(filt, edge_thresh);
        vl_sift_set_peak_thresh(filt, peak_thresh);
    }
    
    int vl_status = vl_sift_process_first_octave(filt, data_);
    
    keypoints.reserve(2000);
    
    while (vl_status != VL_ERR_EOF)
    {
        vl_sift_detect(filt);
        
        const VlSiftKeypoint* vl_keypoints = vl_sift_get_keypoints(filt);
        int nkeys = vl_sift_get_nkeypoints(filt);
        
        for (int i = 0; i &lt; nkeys; ++i)
        {
            double angles[4];
            int nangles = vl_sift_calc_keypoint_orientations(filt, angles, &amp;vl_keypoints[i]);
            
            for (int j = 0; j &lt; nangles; ++j)
            {
                Keypoint keypoint(Vec2(vl_keypoints[i].x + 1, vl_keypoints[i].y + 1), type_);
                keypoint.scale(vl_keypoints[i].sigma);
                keypoint.orientation(angles[j]);
                keypoints.push_back(keypoint);
            }
        }
        vl_status = vl_sift_process_next_octave(filt);
    }
    
    return 0;
}
</code></pre>
</div>

  </article>

  

</div>

      </div>
    </div>

    <footer>

  <div class="wrapper">
    &copy; Copyright 2017 Kai Wu.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.

    
  </div>

</footer>


    <!-- Load jQuery -->
<script src="//code.jquery.com/jquery-1.12.4.min.js"></script>

<!-- Load Common JS -->
<script src="//imkaywu.github.io/assets/js/common.js"></script>





<!-- Include custom icon fonts -->
<link rel="stylesheet" href="//imkaywu.github.io/assets/css/font-awesome.min.css">
<link rel="stylesheet" href="//imkaywu.github.io/assets/css/academicons.min.css">

<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-XXXXXXXX-X', 'auto');
ga('send', 'pageview');
</script>


  </body>

</html>
